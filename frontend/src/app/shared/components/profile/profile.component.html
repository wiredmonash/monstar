<!-- Signed out state will show the sign up page -->
@if (state === 'signed out' || state === 'logged out') {
    <div class="signup-form">
        <!-- Signup form -->
        @if (state === 'signed out') {
            <!-- Sign Up Form -->
            <div class="left">
                <!-- Email input -->
                <div class="email-container">
                    <p-floatLabel>
                        <input id="email"
                            pInputText
                            class="{{ isEmailInputValid ? '' : 'ng-invalid ng-dirty' }}"
                            type="text"
                            [(ngModel)]="inputEmail"
                            (focus)="
                                isEmailInputValid = true;
                                isUserSignUpDuplicate = false;
                            "
                            aria-labelledby="email-help"
                        />
                        <label for="email">Monash Email</label>
                    </p-floatLabel>

                    @if (!isEmailInputValid) {
                        <small id="email-help" style="background-color: rgb(248, 113, 113);">Email invalid (enter Monash email)</small>
                    }
                    @else if (isUserSignUpDuplicate) {
                        <small id="email-help" style="background-color: rgb(248, 113, 113);">User with that email already exists.</small>
                    }
                    @else {
                        <small id="email-help">e.g. abcd0001&#64;student.monash.edu</small>
                    }
                </div>

                <!-- Password input-->
                <div class="password-container mt-1">
                    <p-floatLabel>
                        <p-password id="password"
                            type="password"
                            class="{{ isPasswordsInputValid ? '' : 'ng-invalid ng-dirty' }}"
                            [toggleMask]="true"
                            [(ngModel)]="inputPassword"
                            (onFocus)="isPasswordsInputValid = true;"
                        />
                        <label for="password">Password</label>
                    </p-floatLabel>
                </div>

                <!-- Confirm password input -->
                <div class="confirm-password-container mt-1">
                    <p-floatLabel>
                        <p-password id="confirm-password"
                            type="password"
                            class="{{ isPasswordsInputValid ? '' : 'ng-invalid ng-dirty' }}"
                            [toggleMask]="true"
                            [disabled]="inputPassword == '' ? true : false"
                            [feedback]="false"
                            [(ngModel)]="inputPassword2"
                            (onFocus)="isPasswordsInputValid = true;"
                            aria-labelledby="confirm-password-help"
                        />
                        <label for="confirm-password">Confirm Password</label>
                    </p-floatLabel>
                    @if (!isPasswordsInputValid) {
                        <small id="confirm-password-help" style="background-color: rgb(248, 113, 113);">Passwords do not match!</small>
                    } @else {
                        <small id="confirm-password-help">Retype your password to confirm.</small>
                    }
                </div>

                <!-- Sign Up Button -->
                <p-button
                    label="Sign Up"
                    icon="pi pi-user-plus"
                    styleClass="w-10rem mx-auto"
                    [loading]="signingUp"
                    (click)="signup()"
                />

                <!-- Switch to login -->
                <p>Already have an account?
                    <a
                        pButton
                        type="button"
                        class="p-button-link"
                        (click)="state='logged out'; titleChangeEvent.emit('Login');"
                    >
                        Login Here
                    </a>
                </p>
            </div>
        }

        <!-- Login form -->
        @else if (state === 'logged out') {
            <!-- Login Form -->
            <div class="left">
                <!-- Email input -->
                <div class="email-container">
                    <p-floatLabel>
                        <input id="email" 
                            pInputText 
                            class="{{ 
                                ((isEmailInputValid || isEmailInputVerified) ? '' : 'ng-invalid ng-dirty') ||
                                (isVerifyEmailSentCapped ? 'ng-invalid ng-dirty' : '')
                            }}"
                            type="text" 
                            [(ngModel)]="inputEmail" 
                            (focus)="
                                isEmailInputVerified = true;
                                isEmailInputValid = true;
                                isVerifyEmailSentCapped = false;
                            "
                            aria-labelledby="email-help"
                        />
                        <label for="email">Monash Email</label>
                    </p-floatLabel>
                    @if (!isEmailInputValid) {
                        <small id="email-help" style="background-color: rgb(248, 113, 113);">Email invalid (enter Monash email)</small>
                    }
                    @else if (!isEmailInputVerified) {
                        <small id="email-help" style="background-color: rgb(248, 113, 113);">User not verified, check your email.</small>
                    }
                    @else if (isVerifyEmailSentCapped) {
                        <small id="email-help" style="background-color: rgb(248, 113, 113);">Too many requests, please wait a while.</small>
                    }
                </div>

                <!-- Password input-->
                <div class="password-container mt-1">
                    <p-floatLabel>
                        <p-password id="password"
                            type="password"
                            class="{{
                                (isPasswordsInputValid ? '' : 'ng-invalid ng-dirty') ||
                                (isVerifyEmailSentCapped ? 'ng-invalid ng-dirty' : '')
                            }}"
                            [toggleMask]="true"
                            [feedback]="false"
                            [(ngModel)]="inputPassword"
                            (onFocus)="
                                isPasswordsInputValid = true;
                                isVerifyEmailSentCapped = false;
                            "
                        />
                        <label for="password">Password</label>
                    </p-floatLabel>
                    @if (!isPasswordsInputValid && !isVerifyEmailSentCapped) {
                        <small id="password-help" style="background-color: rgb(248, 113, 113);">Invalid email or password</small>
                    }
                </div>

                <!-- Login Submission -->
                <p-button label="Login" icon="pi pi-user" styleClass="w-10rem mx-auto" (click)="login()" [loading]="loggingIn" />

                <!-- Additional links -->
                <div class="additional-links">
                    <!-- "Don't have an account? Sign Up" Link changes state to 'signed out'-->
                    <p>
                        Don't have an account?
                        <a pButton type="button" class="p-button-link"
                            (click)="state='signed out'; titleChangeEvent.emit('Sign Up');"
                        >Sign Up</a>
                    </p>

                    <!-- "Forgot your password?" Link -->
                    <p class="forgot-password">
                        <a pButton type="button" class="p-button-link"
                            (click)="state='forgot password'; titleChangeEvent.emit('Forgot Password');"
                        >I forgor my password...</a>
                    </p>
                </div>
            </div>
        }

        <!-- Divider -->
        <div class="middle">
            <p-divider layout="vertical">
                <b>OR</b>
            </p-divider>
        </div>

        <!-- "Sign in Monash Gmail" Button -->
        <div class="right">
            @if (isGoogleLoading) {
                <p-skeleton width="199px" height="40px"></p-skeleton>
            } 
            @else if (googleLoadError) {
                <p-button
                    label="Refresh page for Google Sign-In"
                    icon="pi pi-refresh"
                    (click)="reloadPage();"
                ></p-button>
            } @else {
                <div class="google-button-container">
                    <!-- The google button -->
                    <div #googleSignInButton [style]="{ 'z-index': '-9999' }"></div>
                    <!-- Skeleton that is shown above it to hide bad styling initially -->
                    @if (showGoogleSkeleton) {
                        <p-skeleton 
                            width="200px" 
                            height="44px" 
                            [style]="{ 'position': 'absolute', 'top': '0', 'left': '0', 'z-index': '10000' }"
                        ></p-skeleton>
                    }
                </div>
            }
        </div>
    </div>
}

<!-- Confirmation after signing up -->
@else if (state === 'signed up') {
    <div class="confirmation">
        To be able to log in you must verify your email, check your inbox for the email you registered with.
    </div>
}

<!-- Frogot password state -->
@else if (state === 'forgot password') {
    <div class="forgot-password-form">
        <!-- Subheader -->
        <p>Enter your email to reset your password (don't forget it again dummy)</p>
        <!-- Input to take email -->
        <input pInputText placeholder="Enter your email" [disabled]="profileLoading" [(ngModel)]="inputForgotPasswordEmail" />
        <!-- Send reset email button -->
        <p-button label="Send Reset Email" icon="pi pi-envelope" [disabled]="profileLoading" (click)="forgotPassword()"></p-button>
        <!-- ! Error text -->
        @if (isResetEmailSentCapped) {
            <small class="error-text">Please wait {{ resetEmailTimer }} before requesting another reset email.</small>
        }
        <!-- Back to login button -->
        <p>
            <a pButton type="button" class="p-button-link"
                (click)="state='logged out'; titleChangeEvent.emit('Login');"
            >Back to Login</a>
        </p>
    </div>
}

<!-- Logged in state will show the profile -->
@else if (state === 'logged in') {
    <div class="profile">
        <!-- Left-Hand Side Menu Options -->
        <p-menu #profileMenu [model]="profileMenuItems"></p-menu>

        <!-- Vertical Divider -->
        <p-divider layout="vertical"></p-divider>

        <!-- If we have a user then we are logged in and we can show stuff :) -->
        @if (user) {
            <!-- Details-->
            @if (profileMenuState === 'details') {
                @if (!profileLoading) {
                    <div class="update-details">
                        <!-- Details title -->
                        <h4 class="title">Your Details</h4>

                        <!-- Avatar and username card -->
                        <p-card class="avatar-card m-0" [style]="{ 'overflow': 'hidden', 'width': 'fit-content' }">
                            <div class="d-flex align-items-center p-0">

                                <!-- Profile picture -->
                                <img
                                    [src]="user.profileImg || 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSWwfGUCDwrZZK12xVpCOqngxSpn0BDpq6ewQ&s'"
                                    alt="Profile Picture"
                                    class="mr-3 avatar"
                                >

                                <!-- Avatar upload overlay (hidden by default) -->
                                <div class="avatar-overlay" (click)="uploadAvatar()" pTooltip="Upload (5 MB)" tooltipPosition="top">
                                    <i class="pi pi-upload upload-icon"></i>
                                </div>

                                <!-- Username -->
                                <span>{{ user.username || 'No User' }}</span>
                            </div>
                        </p-card>

                        <!-- Update username input -->
                        <ng-container class="input-container">
                            <p-floatLabel>
                                <input pInputText id="username" variant="filled" [(ngModel)]="inputUpdateUsername" (focus)="isUsernameInputValid = true;"/>
                                <label for="username">Update your Username</label>
                            </p-floatLabel>
                        </ng-container>

                        @if (!isUsernameInputValid) {
                          <small id="username-help" style="background-color: rgb(248, 113, 113);">Invalid Username (Please enter an alphanumeric username <= 20 characters)</small>
                        }

                        <!-- Update password input -->
                        @if (!user.isGoogleUser) {
                            <p-floatLabel>
                                <input pInputText id="password" variant="filled" type="password" [(ngModel)]="inputUpdatePassword" />
                                <label for="password">New Password (optional)</label>
                            </p-floatLabel>
                        }

                        <!-- Submit changes to update details -->
                        <p-button label="Update Details" class="update-details-button" styleClass="padding-top: 2rem;" (onClick)="updateDetails()"></p-button>
                    </div>
                } @else {
                    <!-- Loading when the profileLoading is true -->
                    <p-progressSpinner class="mx-auto"></p-progressSpinner>
                }
            }
            <!-- Reviews -->
            @else if (profileMenuState === 'reviews') {
                <!-- This is the table of the reviews that the user has written -->
                <div class="reviews-container">
                    <p-table 
                        [value]="reviews" 
                        [tableStyle]="{ 'min-width': '40rem', 'max-width': '50rem' }"
                        styleClass="p-datatable-striped"
                    >
                        <ng-template pTemplate="caption">
                            <div class="flex align-items-center justify-content-between" style="user-select: none;">
                                Your Reviews
                            </div>
                        </ng-template>
                        <ng-template pTemplate="header">
                            <tr style="user-select: none;">
                                <th>Date</th>
                                <th>Unit</th>
                                <th>TItle</th>
                                <th>Rating</th>
                                <th>Likes</th>
                                <th>Dislikes</th>
                                <th>Actions</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-review>
                            <tr>
                                <!-- Date of review creation -->
                                <td>
                                    {{ review.createdAt | date: 'dd/MM/yyyy' }}
                                </td>
                                <!-- Unitcode of the unit that the review is in -->
                                <td style="user-select: none;">{{ review.unit.unitCode | uppercase }}</td>
                                <!-- Title of review -->
                                <td style="user-select: none;">{{ review.title }}</td>
                                <!-- Rating stars -->
                                <td>
                                    <p-rating 
                                        [(ngModel)]="review.overallRating"
                                        [readonly]="true"
                                        [cancel]="false"
                                        style="user-select: none; pointer-events: none; cursor: default;"
                                    />
                                </td>
                                <!-- Likes of this review -->
                                <td style="text-align: center; user-select: none;">
                                    {{ review.likes }}
                                </td>
                                <!-- Dislikes of this review -->
                                <td style="text-align: center; user-select: none;">
                                    {{ review.dislikes }}
                                </td>
                                <!-- Actions to edit and delete the review -->
                                <td>
                                    <!-- TODO: Edit button is disabled because there is no functionality for this yet -->
                                    <button pButton [disabled]="true" icon="pi pi-pencil" class="p-button-rounded p-button-text" ></button>
                                    <!-- Button to delete the current review -->
                                    <button pButton icon="pi pi-trash" class="p-button-rounded p-button-text" (click)="this.deleteReview(review._id)"></button>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            }
            <!-- Friends -->
            @else if (profileMenuState === 'friends') {
                <div class="friends-container">
                    <!-- TODO: Make the friends list here and the suggested friends list -->
                </div>
            }
        } @else {
            <!-- Loading when no user assigned yet -->
            <p-progressSpinner class="mx-auto"></p-progressSpinner>
        }
    </div>
}
