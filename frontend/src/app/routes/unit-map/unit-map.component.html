<!-- === Bottom Toolbar === -->
@if (!isLoading) {
    <div class="toolbar-container">
        <p-toolbar class="toolbar" styleClass="shadow-2" [style]="{ 'border-radius': '3rem' }">
        <!-- ! Start group (Simple sorting order dropdown) -->
        <div class="p-toolbar-group-start">
            <p-button 
                pTooltip="Reset Graph"
                tooltipPosition="top"
                tooltipZIndex="9999"
                icon="pi pi-replay"
                rounded="true"
                (click)="resetGraph()"
            ></p-button>
        </div>
    
        <!-- ! Center group (dynamic search bar)-->
        <div class="p-toolbar-group-center">
            <p-button 
                pTooltip="Center Graph"
                tooltipPosition="top"
                tooltipZIndex="9999"
                icon="pi pi-arrow-down-left-and-arrow-up-right-to-center"
                rounded="true"
                (click)="centerGraph()"
            ></p-button>
        </div>
    
        <!-- ! End group (Advanced filtering options) -->
        <div class="p-toolbar-group-end">
            <p-button 
                pTooltip="Zoom to Fit"
                tooltipPosition="top"
                tooltipZIndex="9999"
                icon="pi pi-expand"
                rounded="true"
                (click)="resetZoom()"
            ></p-button>
        </div>
        </p-toolbar>
    </div>
}

<!-- === Background, Graph, and Loading Overlay === -->
<div #graphContainer class="graph-container">
    <!-- ! Dotted Background -->
    <svg width="100%" height="100%" class="background-pattern">
        <defs>
            <pattern id="dotPattern" width="20" height="20" patternUnits="userSpaceOnUse">
                <circle cx="2" cy="2" r="1" fill="rgba(255,255,255,0.2)"/>
            </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#dotPattern)"/>
    </svg>

    <!-- ! Arrow marker defintions -->
    <svg width="0" height="0">
        <defs>
            <marker
                id="arrow"
                viewBox="0 -5 10 10"
                refX="30"
                refY="0"
                markerWidth="6"
                markerHeight="6"
                orient="auto">
                <path d="M0,-5L10,0L0,5" class="arrow-head"/>
            </marker>
            <marker
                id="prerequisite-arrow"
                viewBox="0 -5 10 10"
                refX="30"
                refY="0"
                markerWidth="6"
                markerHeight="6"
                orient="auto">
                <path d="M0,-5L10,0L0,5" class="prerequisite-arrow-head"/>
            </marker>
            <marker
                id="parent-arrow"
                viewBox="0 -5 10 10"
                refX="30"
                refY="0"
                markerWidth="6"
                markerHeight="6"
                orient="auto">
                <path d="M0,-5L10,0L0,5" class="parent-arrow-head"/>
            </marker>
        </defs>
    </svg>

    <!-- ! Graph -->
    <ngx-graph
        [view]="[graphContainer.offsetWidth, graphContainer.offsetHeight]" 
        [links]="edges"
        [nodes]="nodes"
        [layout]="layout"
        [curve]="curve"
        [autoZoom]="false"
        [center$]="center$"
        [zoomToFit$]="zoomToFit$"
        [deferDisplayUntilPosition]="true"
    >
        <!-- * Nodes -->
        <ng-template #nodeTemplate let-node>
            <svg:g class="node" [class]="node.data?.type">
            <svg:rect
                [attr.width]="90"
                [attr.height]="30"
                [attr.rx]="8"
            />
            <svg:text
                alignment-baseline="middle"
                dominant-baseline="middle"
                [attr.x]="45"
                [attr.y]="15"
            >
                {{node.label}}
            </svg:text>
            </svg:g>
        </ng-template>
        <!-- * Edges for edging -->
        <ng-template #linkTemplate let-edge>
            <svg:g class="edge" [class]="edge.data?.type">
            <svg:path
                class="line"
                [attr.marker-end]="'url(#' + (edge.data?.type || 'arrow') + '-arrow)'"
            />
            </svg:g>
        </ng-template>
    </ngx-graph>
    
    <!-- ! The loading overlay screen (this must be put here) -->
    @if (isLoading) {
        <div class="loading-overlay">
            <div class="loader">
                <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                <span>Loading Unit Map...</span>
            </div>
        </div>
    }
</div>