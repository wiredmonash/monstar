<!-- Loading State -->
@if (loading) {
  <div class="loading-container">
    <p-progressSpinner
      styleClass="custom-spinner"
      strokeWidth="3"
    ></p-progressSpinner>
    <p class="loading-text">Loading SETU data...</p>
  </div>
}

<!-- Error State -->
@else if (error) {
  <div class="error-container">
    <div class="error-content">
      <i class="pi pi-exclamation-triangle error-icon"></i>
      <h3>Unable to Load SETU Data</h3>
      <p>{{ error }}</p>
      <p-button
        label="Go Back"
        icon="pi pi-arrow-left"
        (click)="navigateBack()"
        severity="secondary"
      ></p-button>
    </div>
  </div>
}

<!-- SETU Data Display -->
@else if (setuData.length === 0) {
  <div class="no-data-container">
    <div class="no-data-content">
      <i class="pi pi-info-circle no-data-icon"></i>
      <h3>No SETU Data Available</h3>
      <p>
        There is no SETU evaluation data available for {{ unitCode | uppercase }}.
      </p>
      <p-button
        label="Go Back"
        icon="pi pi-arrow-left"
        (click)="navigateBack()"
        severity="secondary"
      ></p-button>
    </div>
  </div>
} @else {
  <!-- Header Section -->
  <div class="setu-header">
    <div class="header-content">
      <div class="unit-info">
        <div class="back-button">
          <p-button
            icon="pi pi-arrow-left"
            [rounded]="true"
            [text]="true"
            (click)="navigateBack()"
            pTooltip="Go back to unit overview"
            tooltipPosition="right"
          ></p-button>
        </div>
        <h1 class="unit-code">{{ unitCode | uppercase }}</h1>
        <h2 class="page-title">SETU Evaluation Results</h2>
      </div>

      @if (getSelectedSetu()) {
        <div class="setu-info">
          <div class="info-item">
            <span class="label">Viewing Evaluation:</span>
            <span class="value">{{
              getSeasonDisplay(getSelectedSetu()!.Season)
            }}</span>
          </div>
          <div class="info-item">
            <span class="label">Responses:</span>
            <span class="value"
              >{{ getSelectedSetu()!.Responses }} /
              {{ getSelectedSetu()!.Invited }}</span
            >
            <p-badge
              [value]="getResponseRatePercent(getSelectedSetu()!) + '%'"
              severity="info"
              class="ml-2"
            ></p-badge>
          </div>
          @if (getSelectedSetu()!.getAggregateScore() > 0) {
            <div class="info-item">
              <span class="label">Overall Score:</span>
              <span
                class="value aggregate-score"
                [style.color]="getScoreColor(getSelectedSetu()!.getAggregateScore())"
              >
                {{ getFormattedScore(getSelectedSetu()!.getAggregateScore()) }}/5.0
              </span>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Available SETU Data Section -->
  @if (setuData.length > 1) {
    <p-divider></p-divider>

    <div class="historical-container">
      <h3 class="historical-title">
        All Available SETU Data - Click to View Details
      </h3>

      <p-carousel
        [value]="setuData"
        [numVisible]="4"
        [numScroll]="1"
        [circular]="false"
        [showNavigators]="true"
        [showIndicators]="false"
        [responsiveOptions]="responsiveOptions"
        styleClass="setu-carousel"
      >
        <ng-template let-setu pTemplate="item">
          <div class="carousel-item-wrapper">
            <div class="historical-card" [class.selected]="isSetuSelected(setu)">
              <p-card
                (click)="selectSetuData(setu)"
                [style]="{ cursor: 'pointer', height: '100%' }"
                [class]="isSetuSelected(setu) ? 'selected-card' : ''"
              >
                <div class="historical-content">
                  <div class="historical-header">
                    <h4>{{ getSeasonDisplay(setu.Season) }}</h4>
                    <div class="historical-info">
                      <span class="responses">{{ setu.Responses }} responses</span>
                      <p-badge
                        [value]="getResponseRatePercent(setu) + '%'"
                        severity="info"
                      ></p-badge>
                    </div>
                  </div>

                  @if (setu.getAggregateScore() > 0) {
                    <div class="aggregate-display">
                      <span class="aggregate-label">Overall Score:</span>
                      <span
                        class="aggregate-value"
                        [style.color]="getScoreColor(setu.getAggregateScore())"
                      >
                        {{ getFormattedScore(setu.getAggregateScore()) }}/5.0
                      </span>
                    </div>
                  }
                </div>
              </p-card>
            </div>
          </div>
        </ng-template>
      </p-carousel>
    </div>
  }

  <p-divider></p-divider>

  <!-- SETU Criteria Grid -->
  @if (getSelectedSetu()) {
    <div class="criteria-container">
      <!-- University Wide Items (First 8 Criteria) -->
      <div class="criteria-section">
        <h3 class="criteria-title">University Wide Items</h3>
        <div class="criteria-grid">
          @for (criteria of getSelectedSetu()!.getAllCriteriaScores().slice(0, 8); track criteria.key) {
            <div class="criteria-card university-wide-card">
              <p-card [style]="{ height: '100%' }">
                <div class="criteria-content">
                  <!-- Criteria Label with Tooltip -->
                  <h4
                    class="criteria-label"
                    [pTooltip]="getCriteriaTooltip(criteria.key)"
                    tooltipPosition="top"
                  >
                    {{ criteria.label }} <i class="pi pi-info-circle"></i>
                  </h4>

                  <!-- Knob Rating Display -->
                  <p-knob
                    [(ngModel)]="criteria.score"
                    [readonly]="true"
                    [size]="80"
                    [strokeWidth]="16"
                    [valueColor]="getScoreColor(criteria.score)"
                    [rangeColor]="'rgba(255,255,255,0.2)'"
                    [valueTemplate]="getFormattedScore(criteria.score)"
                    [max]="5"
                    [step]="0.1"
                  ></p-knob>
                </div>
              </p-card>
            </div>
          }
        </div>
      </div>

      <!-- Faculty Wide Items (Last 5 Criteria) -->
      <div class="criteria-section">
        <h3 class="criteria-title">Faculty Wide Items</h3>
        <div class="criteria-grid">
          @for (criteria of getSelectedSetu()!.getAllCriteriaScores().slice(8); track criteria.key) {
            <div class="criteria-card university-wide-card">
              <p-card [style]="{ height: '100%' }">
                <div class="criteria-content">
                  <!-- Criteria Label with Tooltip -->
                  <h4
                    class="criteria-label"
                    [pTooltip]="getCriteriaTooltip(criteria.key)"
                    tooltipPosition="top"
                  >
                    {{ criteria.label }} <i class="pi pi-info-circle"></i>
                  </h4>

                  <!-- Knob Rating Display -->
                  <p-knob
                    [(ngModel)]="criteria.score"
                    [readonly]="true"
                    [size]="80"
                    [strokeWidth]="16"
                    [valueColor]="getScoreColor(criteria.score)"
                    [rangeColor]="'rgba(255,255,255,0.2)'"
                    [valueTemplate]="getFormattedScore(criteria.score)"
                    [max]="5"
                    [step]="0.1"
                  ></p-knob>
                </div>
              </p-card>
            </div>
          }
        </div>
      </div>
    </div>
  } 
}
